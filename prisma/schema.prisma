generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String   @id @default(cuid())
  clerkId             String   @unique
  email               String   @unique
  firstName           String?
  lastName            String?
  imageUrl            String?
  subscriptionTier    String   @default("free")
  subscriptionStatus  String   @default("active")
  businessName        String?
  businessDescription String?  @db.Text
  businessType        String?
  businessIndustry    String?
  aiEnabled           Boolean  @default(false)
  aiInstructions      String?  @db.Text
  aiTone              String?  @default("professional")
  aiPersonality       String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  stripeCustomerId    String?
  paymentMethods      PaymentMethod[]

  instagramAccounts  InstagramAccount[]
  automations        Automation[]
  conversations      Conversation[]
  contentPosts       ContentPost[]
  tags               Tag[]
  analytics          Analytics[]
  quickReplies       QuickReply[]
  messageTemplates   MessageTemplate[]
  savedFilters       SavedFilter[]
  products           Product[]
  orders             Order[]
  appointments       Appointment[]
  supportTickets     SupportTicket[]
  integrations       Integration[]
  knowledgeDocuments KnowledgeDocument[]
  businessProfile    BusinessProfile?

  payments           Payment[] // added payments relationship
  subscription       Subscription? // added subscription relationship
  notifications      Notification[]


  @@index([clerkId])
  @@index([email])
  @@index([subscriptionTier])
}

model PaymentMethod {
  id                      String   @id @default(cuid())
  userId                  String
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripePaymentMethodId   String   @unique
  last4                   String
  brand                   String
  expiryMonth             Int
  expiryYear              Int
  isDefault               Boolean  @default(false)

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([userId])
  @@index([isDefault])
}

model InstagramAccount {
  id              String    @id @default(cuid())
  userId          String
  instagramId     String    @unique
  instagramPageId String?   @unique
  username        String
  profilePicUrl   String?
  followerCount   Int       @default(0)
  accessToken     String    @db.Text
  tokenExpiry     DateTime?
  isConnected     Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  disconnectedAt  DateTime?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]
  automations   Automation[]

  @@index([userId])
  @@index([instagramId])
}

model Automation {
  id                 String   @id @default(cuid())
  userId             String
  instagramAccountId String?
  name               String
  description        String?
  status             String   @default("draft")
  isActive           Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  instagramAccount InstagramAccount?     @relation(fields: [instagramAccountId], references: [id], onDelete: SetNull)
  triggers         AutomationTrigger[]
  actions          AutomationAction[]
  executions       AutomationExecution[]

  @@index([userId])
  @@index([instagramAccountId])
  @@index([isActive])
}

model AutomationTrigger {
  id           String @id @default(cuid())
  automationId String
  type         String
  conditions   Json
  order        Int    @default(0)

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
}

model AutomationAction {
  id           String @id @default(cuid())
  automationId String
  type         String
  content      Json
  order        Int

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([order])
}

model AutomationExecution {
  id             String    @id @default(cuid())
  automationId   String
  conversationId String
  status         String
  error          String?   @db.Text
  triggeredBy    String
  executedAt     DateTime  @default(now())
  completedAt    DateTime?

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([conversationId])
  @@index([executedAt])
}

model MessageQueue {
  id             String    @id @default(cuid())
  conversationId String
  messageContent String    @db.Text
  recipientId    String
  scheduledFor   DateTime
  status         String    @default("pending")
  retryCount     Int       @default(0)
  maxRetries     Int       @default(3)
  error          String?   @db.Text
  metadata       Json?
  createdAt      DateTime  @default(now())
  processedAt    DateTime?

  @@index([status])
  @@index([scheduledFor])
  @@index([conversationId])
}

model Conversation {
  id                      String    @id @default(cuid())
  instagramAccountId      String
  userId                  String
  participantId           String
  participantName         String
  participantUsername     String
  participantAvatar       String?
  instagramConversationId String?
  lastMessageText         String?
  lastMessageAt           DateTime?
  lastCustomerMessageAt   DateTime?
  unreadCount             Int       @default(0)
  isRead                  Boolean   @default(false)
  isAuto                  Boolean   @default(true)
  starred                 Boolean   @default(false)
  notes                   String?   @db.Text
  isArchived              Boolean   @default(false)
  needsHumanReview        Boolean   @default(false)
  handoffReason           String?
  priorityScore           Int       @default(0)
  category                String    @default("general")
  status                  String    @default("open")
  isVip                   Boolean   @default(false)
  assignedToUserId        String?
  firstContactAt          DateTime  @default(now())
  lastResponseTime        Int?
  customerEmail           String?
  customerPhone           String?
  customerPreferences     Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  instagramAccount   InstagramAccount    @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages           Message[]
  conversationTags   ConversationTag[]
  internalNotes      InternalNote[]
  reminders          Reminder[]
  aiSuggestions      AISuggestion[]
  aiInteractions     AIInteraction[]
  pendingAIResponses PendingAIResponse[]
  orders             Order[]
  appointments       Appointment[]
  supportTickets     SupportTicket[]
  queuedMessages     QueuedMessage[]

  @@index([userId])
  @@index([instagramAccountId])
  @@index([participantId])
  @@index([needsHumanReview])
  @@index([isRead])
  @@index([starred])
  @@index([isArchived])
  @@index([priorityScore])
  @@index([category])
  @@index([status])
  @@index([isVip])
  @@index([assignedToUserId])
}

model Message {
  id                 String   @id @default(cuid())
  conversationId     String
  content            String   @db.Text
  sender             String
  isFromUser         Boolean  @default(false)
  isRead             Boolean  @default(false)
  timestamp          DateTime @default(now())
  messageType        String   @default("text")
  attachmentUrl      String?
  attachmentMetadata Json?
  sentByAutomation   Boolean  @default(false)
  automationId       String?
  sentByAI           Boolean  @default(false)
  metadata           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
}

model Tag {
  id        String   @id @default(cuid())
  userId    String
  name      String
  color     String   @default("#8B5CF6")
  createdAt DateTime @default(now())

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationTags ConversationTag[]

  @@unique([userId, name])
  @@index([userId])
}

model ConversationTag {
  conversationId String
  tagId          String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tag          Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([conversationId, tagId])
  @@index([conversationId])
  @@index([tagId])
}

model QuickReply {
  id        String   @id @default(cuid())
  userId    String
  name      String
  content   String   @db.Text
  shortcut  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model ContentPost {
  id           String    @id @default(cuid())
  userId       String
  caption      String    @db.Text
  mediaUrls    String[]
  hashtags     String[]
  location     String?
  status       String    @default("draft")
  scheduledFor DateTime?
  postedAt     DateTime?
  aiGenerated  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
}

model Analytics {
  id                   String   @id @default(cuid())
  userId               String
  date                 DateTime
  messagesReceived     Int      @default(0)
  messagesSent         Int      @default(0)
  conversationsStarted Int      @default(0)
  automationTriggered  Int      @default(0)
  contentGenerated     Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

model InternalNote {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  content        String   @db.Text
  mentions       String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
}

model MessageTemplate {
  id         String   @id @default(cuid())
  userId     String
  title      String
  content    String   @db.Text
  category   String   @default("general")
  variables  String[]
  usageCount Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([category])
  @@index([usageCount])
}

model Reminder {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  message        String    @db.Text
  remindAt       DateTime
  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([userId])
  @@index([remindAt])
  @@index([isCompleted])
}

model AISuggestion {
  id             String   @id @default(cuid())
  conversationId String
  suggestions    String[]
  context        Json
  createdAt      DateTime @default(now())
  expiresAt      DateTime

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId])
  @@index([conversationId])
  @@index([expiresAt])
}

model SavedFilter {
  id        String   @id @default(cuid())
  userId    String
  name      String
  filters   Json
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model KnowledgeDocument {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  content String   @db.Text
  type    String
  tags    String[]

  embedding Float[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AIInteraction {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  userMessage String @db.Text
  aiResponse  String @db.Text

  sentiment     String
  confidence    Float
  shouldHandoff Boolean @default(false)

  usedFunctions String[]
  metadata      Json?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

model PendingAIResponse {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  response   String @db.Text
  confidence Float
  sentiment  String

  status     String    @default("pending")
  reviewedBy String?
  reviewedAt DateTime?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([status])
}

model Integration {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type     String
  name     String
  isActive Boolean @default(true)

  config   Json
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, type])
  @@index([userId])
  @@index([type])
}

model Product {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name           String
  description    String @db.Text
  price          Int
  compareAtPrice Int?

  imageUrl String?
  images   String[]

  category String?
  tags     String[]
  sku      String?
  barcode  String?

  stock       Int     @default(0)
  isAvailable Boolean @default(true)

  hasVariants Boolean          @default(false)
  variants    ProductVariant[]

  slug String? @unique

  metadata Json?

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sku])
  @@index([userId])
  @@index([category])
  @@index([isAvailable])
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name  String
  price Int?
  sku   String?
  stock Int     @default(0)

  options Json

  @@unique([productId, sku])
  @@index([productId])
}

model Order {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  customerName  String
  customerEmail String?
  customerPhone String?

  orderNumber String @unique
  status      String @default("pending")

  subtotal Int
  tax      Int @default(0)
  shipping Int @default(0)
  discount Int @default(0)
  total    Int

  currency String @default("USD")

  shippingAddress   Json?
  trackingNumber    String?
  estimatedDelivery DateTime?

  paymentStatus String  @default("pending")
  paymentMethod String?
  paymentId     String?

  items OrderItem[]

  metadata Json?
  notes    String? @db.Text

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  @@index([userId])
  @@index([conversationId])
  @@index([status])
  @@index([paymentStatus])
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  name     String
  price    Int
  quantity Int
  subtotal Int

  variantId String?
  options   Json?

  @@index([orderId])
  @@index([productId])
}

model PaymentAttempt {
  id             String @id @default(cuid())
  userId         String
  conversationId String

  amount   Int
  currency String
  status   String @default("pending")

  stripePaymentLinkId   String?
  stripePaymentIntentId String?

  metadata Json?

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  @@index([conversationId])
  @@index([status])
}

model Appointment {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  customerName     String
  customerUsername String?
  customerEmail    String?
  customerPhone    String?

  service         String
  date            DateTime
  durationMinutes Int      @default(60)

  status String @default("pending")

  googleCalendarEventId String?

  notes String? @db.Text

  reminderSent Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([conversationId])
  @@index([date])
  @@index([status])
}

model SupportTicket {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  customerName String
  subject      String
  description  String @db.Text

  status   String @default("open")
  priority String @default("medium")

  assignedTo String?

  zendeskTicketId String?
  hubspotTicketId String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  @@index([userId])
  @@index([conversationId])
  @@index([status])
  @@index([priority])
}

model QueuedMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  type    String
  content Json

  status       String    @default("pending")
  scheduledFor DateTime
  sentAt       DateTime?

  error String?

  createdAt DateTime @default(now())

  @@index([conversationId])
  @@index([status])
  @@index([scheduledFor])
}

model BusinessProfile {
  id     String @id @default(cuid())
  userId String @unique

  // Core Info
  businessType String
  businessName String
  description  String @db.Text
  industry     String

  // AI Configuration
  aiPersonality Json
  knowledgeBase Json

  // Features Enabled
  enableProducts Boolean @default(false)
  enableBooking  Boolean @default(false)
  enablePayments Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}






model Payment {
  id                      String   @id @default(cuid())
  userId                  String
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount                  Int      // amount in cents
  currency                String   @default("usd")
  status                  String   @default("pending") // pending, succeeded, failed
  description             String?
  stripePaymentIntentId   String   @unique
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Subscription {
  id                      String   @id @default(cuid())
  userId                  String   @unique
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tier                    String   @default("free") // free, pro, enterprise
  status                  String   @default("active") // active, canceled, past_due
  currentPeriodStart      DateTime
  currentPeriodEnd        DateTime
  cancelAtPeriodEnd       Boolean  @default(false)
  canceledAt              DateTime?
  stripeSubscriptionId    String?  @unique
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([status])
  @@index([tier])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String
  title     String
  message   String
  icon      String?
  data      Json?
  isRead    Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())
  readAt    DateTime?

  // Relationship
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}