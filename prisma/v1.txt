generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  firstName String?
  lastName  String?
  imageUrl  String?
  subscriptionTier String  @default("free") // free, starter, pro, enterprise
  subscriptionStatus String @default("active") // active, cancelled, past_due
  businessName String?
  businessDescription String? @db.Text
  businessType String? // e-commerce, service, influencer, agency, etc.
  businessIndustry String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instagramAccounts InstagramAccount[]
  automations       Automation[]
  conversations     Conversation[]
  contentPosts      ContentPost[]
  tags              Tag[]
  analytics         Analytics[]

  @@index([clerkId])
  @@index([email])
  @@index([subscriptionTier])
}

model InstagramAccount {
  id            String   @id @default(cuid())
  userId        String
  instagramId   String   @unique
  username      String
  profilePicUrl String?
  followerCount Int      @default(0)
  accessToken   String   @db.Text
  tokenExpiry   DateTime?
  isConnected   Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@index([userId])
  @@index([instagramId])
}

model Automation {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  status      String   @default("draft") // draft, active, paused, archived
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  triggers AutomationTrigger[]
  actions  AutomationAction[]

  @@index([userId])
  @@index([isActive])
}

model AutomationTrigger {
  id           String @id @default(cuid())
  automationId String
  type         String // DM_RECEIVED, KEYWORD, STORY_REPLY, COMMENT, MENTION, FIRST_MESSAGE
  conditions   Json   // { keywords: [], matchType: "contains|exact|regex", userTags: [] }
  order        Int    @default(0)

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
}

model AutomationAction {
  id           String @id @default(cuid())
  automationId String
  type         String // SEND_MESSAGE, ADD_TAG, REMOVE_TAG, DELAY, WEBHOOK, BRANCH, SEND_TO_HUMAN
  content      Json   // { message: "", delayMinutes: 0, tagId: "", webhookUrl: "", condition: {} }
  order        Int

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)

  @@index([automationId])
  @@index([order])
}

model Conversation {
  id                 String   @id @default(cuid())
  instagramAccountId String
  userId             String
  participantId      String   // Instagram user ID
  participantName    String
  participantUsername String
  participantAvatar  String?
  lastMessageText    String?
  lastMessageAt      DateTime?
  unreadCount        Int      @default(0)
  isArchived         Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  instagramAccount InstagramAccount  @relation(fields: [instagramAccountId], references: [id], onDelete: Cascade)
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages         Message[]
  conversationTags ConversationTag[]

  @@index([userId])
  @@index([instagramAccountId])
  @@index([participantId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  content        String   @db.Text
  sender         String   // "user" or "participant"
  isRead         Boolean  @default(false)
  timestamp      DateTime @default(now())
  messageType    String   @default("text") // text, image, video, story_reply

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([timestamp])
}

model Tag {
  id        String   @id @default(cuid())
  userId    String
  name      String
  color     String   @default("#8B5CF6")
  createdAt DateTime @default(now())

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationTags ConversationTag[]

  @@unique([userId, name])
  @@index([userId])
}

model ConversationTag {
  conversationId String
  tagId          String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  tag          Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([conversationId, tagId])
  @@index([conversationId])
  @@index([tagId])
}

model ContentPost {
  id           String    @id @default(cuid())
  userId       String
  caption      String    @db.Text
  mediaUrls    String[]
  hashtags     String[]
  location     String?
  status       String    @default("draft") // draft, scheduled, published, failed
  scheduledFor DateTime?
  postedAt     DateTime?
  aiGenerated  Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
}

model Analytics {
  id                    String   @id @default(cuid())
  userId                String
  date                  DateTime
  messagesReceived      Int      @default(0)
  messagesSent          Int      @default(0)
  conversationsStarted  Int      @default(0)
  automationTriggered   Int      @default(0)
  contentGenerated      Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}
